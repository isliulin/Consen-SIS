/*
***********************************************************************************************************************
*                  Copyright(c) 北京康吉森技术有限公司 2015
*           Beijing Consen Technologies Co.,Ltd. All rights reserved.
*
*
*  项目名称    : 安全控制系统
* 
*  模块名称    :
*
*  文件名称    : PMBUS.c
*
*  功能简介    :
*
*  作者            : 李琦
*
*  创建日期    : 2016-06-21
*
*  版本信息    : V1.0
*
*  修订信息    : 无
*
***********************************************************************************************************************
*/

/*
***********************************************************************************************************************
*                                包含头文件
***********************************************************************************************************************
*/
#include <Srv/Scheduler/cagos.h>
#include "../inc/PMBUS.h"

/*
***********************************************************************************************************************
*                                局部变量声明
***********************************************************************************************************************
*/


/*
***********************************************************************************************************************
*                                局部函数声明
***********************************************************************************************************************
*/


/*
***********************************************************************************************************************
*                                全局函数实现
***********************************************************************************************************************
*/

/*
***********************************************************************************************************************
* 函数名称: PMBUS_Send
*
* 功能描述: 发送数据或状态
*
* 输入参数:
*
* 输出参数: 无
*
* 返 回 值  : 成功或失败
*
* 注意事项: bus_no: pmbus id， 1 - pmbus1 ，2 - pmbus2
*        buf_no: pm recv buffer type, 1 - data buffer , 2 - state buffer
***********************************************************************************************************************
*/
int16_t PMBUS_Send(int8_t bus_no, int8_t buf_no, uint8_t *buf, int32_t len, int32_t timeout)
{
    int16_t res = -1;

    if(((1 == bus_no)||(2 == bus_no))&&((1 == buf_no)||(2 == buf_no))&&(buf != NULL))
    {
        if(copy_to_pmbuf(bus_no, buf, len) >= 0)
        {
            if(enable_pm_send(bus_no, buf_no) >= 0)
            {
                while(1)
                {
                    res = check_pm_send(bus_no);
                    if((res >= 0) || (timeout-- == 0))
                    {
                        break;
                    }
                }
            }
        }
    }

    return res;
}

/*
***********************************************************************************************************************
* 函数名称: PMBUS_Receive
*
* 功能描述: 接收数据或状态
*
* 输入参数:
*
* 输出参数: 无
*
* 返 回 值  : 成功收到数据则返回数据长度，失败则返回-1
*
* 注意事项: bus_no: pmbus id， 1 - pmbus1 ，2 - pmbus2
*        buf_no: pm recv buffer type, 1 - data buffer , 2 - state buffer
***********************************************************************************************************************
*/
int16_t PMBUS_Receive(int8_t bus_no, int8_t buf_no, uint8_t *buf)
{
    int16_t usRes = -1;

    if(((1 == bus_no)||(2 == bus_no))&&((1 == buf_no)||(2 == buf_no))&&(buf != NULL))
    {
        if(check_pm_recv(bus_no,buf_no) >= 0)
        {
            usRes = copy_from_pmbuf(bus_no, buf_no, buf);
        }
    }

    return usRes;
}

/*
***********************************************************************************************************************
* 函数名称: PMBUS_GetReceiveTime
*
* 功能描述: 获取接收时间
*
* 输入参数:
*
* 输出参数: 无
*
* 返 回 值  :
*
* 注意事项: bus_no: pmbus id， 1 - pmbus1 ，2 - pmbus2
*        buf_no: pm recv buffer type, 1 - data buffer , 2 - state buffer
***********************************************************************************************************************
*/
int16_t PMBUS_GetReceiveTime(int8_t bus_no, int8_t buf_no)
{
    int16_t sTime = 0;

    sTime = get_pmrecv_time( bus_no, buf_no);

    return sTime;
}

/*
***********************************************************************************************************************
*                                局部函数实现
***********************************************************************************************************************
*/


/*
***********************************************************************************************************************
                                 文件结束
***********************************************************************************************************************
*/
