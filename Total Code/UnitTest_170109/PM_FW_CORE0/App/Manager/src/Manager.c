/*
***********************************************************************************************************************
*                  Copyright(c) 北京康吉森技术有限公司 2015
*           Beijing Consen Technologies Co.,Ltd. All rights reserved.
*
*
*  项目名称    : 安全控制系统
* 
*  模块名称    : 
*
*  文件名称    : Manager.c
*
*  功能简介    : 
*
*  作者          : 李琦
*
*  创建日期    : 2016-04-13
*
*  版本信息    : V1.0
*
*  修订信息    : 无
*
***********************************************************************************************************************
*/

/*
***********************************************************************************************************************
*                                包含头文件
***********************************************************************************************************************
*/
#include "../inc/Manager.h"
#include "Srv/SharedMem/inc/SharedHandshake.h"
#include "Srv/SharedMem/inc/SharedConfig.h"
#include "Srv/Sys/inc/CommSys.h"
/*
***********************************************************************************************************************
*                                局部变量声明
***********************************************************************************************************************
*/


/*
***********************************************************************************************************************
*                                局部函数声明
***********************************************************************************************************************
*/





/*
***********************************************************************************************************************
*                                全局函数实现
***********************************************************************************************************************
*/

/*
***********************************************************************************************************************
* 函数名称: ManagerInit
*
* 功能描述: 初始化
*
* 输入参数: 无
*
* 输出参数: 无
*
* 返 回 值  : 无
*
* 注意事项: 无
***********************************************************************************************************************
*/
void ManagerInit(void)
{

}

/*
***********************************************************************************************************************
* 函数名称: ManagerCycle
*
* 功能描述: 周期运行函数
*
* 输入参数: 无
*
* 输出参数: 无
*
* 返 回 值  : 无
*
* 注意事项: 无
***********************************************************************************************************************
*/
void ManagerCycle(void)
{
    ulong64_t ulTime = 0;
    bool_t bRet = false;
    AdjSysTimeSignal_t stSysTime;
    CMConfigInfo_t* pstCMcfg = NULL;
    CMController_t i = CM1;

    pstCMcfg = SharedGetCMConfigInfo();

    if(pstCMcfg != NULL)
    {
        bRet = SysGetSysTimeSignal(CORE1_TO_CORE0, &stSysTime);
        if((true == bRet) && (stSysTime.uiSignal == SIGNAL_CM_SYS_TIME))
        {
            for(i = CM1; i < NUM_OF_CM; i++)
            {
                if((ACTIVE == pstCMcfg->stCMSingleInfo[i].emActive) \
                    && (ACTIVE == pstCMcfg->stCMSingleInfo[i].stNTPTCPConfigInfo.emActive))
                {
                    if((0 == pstCMcfg->stCMSingleInfo[i].stNTPTCPConfigInfo.ucTimingSrc)\
                            || (1 == pstCMcfg->stCMSingleInfo[i].stNTPTCPConfigInfo.ucTimingSrc))
                    {
                        ulTime = (ulong64_t)stSysTime.uiSec * 1000; //ms
                        ulTime += (ulong64_t)(stSysTime.uiMilSec );
                        ulTime = ulTime * 1000; //us
                        SysAdjustSystemTime(ulTime);
                        SysAdjustSystemTimeEnable();
                    }
                }
            }
        }
    }

    return;
}


/*
***********************************************************************************************************************
*                                局部函数实现
***********************************************************************************************************************
*/


/*
***********************************************************************************************************************
                                 文件结束
***********************************************************************************************************************
*/
